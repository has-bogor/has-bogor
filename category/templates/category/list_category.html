<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Category Management</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 p-10">
    <div class="max-w-3xl mx-auto">
        <h1 class="text-2xl font-bold mb-6 text-center">Manage Categories</h1>

        <!-- Sorting Buttons -->
        <div class="text-center mb-4">
            <button onclick="fetchCategories('asc')" class="bg-gray-200 py-2 px-4 mr-2 rounded">Sort Ascending</button>
            <button onclick="fetchCategories('desc')" class="bg-gray-200 py-2 px-4 rounded">Sort Descending</button>
        </div>

        <input type="text" id="searchBar" placeholder="Search categories" 
        class="border py-2 px-3 rounded w-full mb-4" oninput="searchCategories()">

        <!-- Add Category Form -->
        <div class="mb-6">
            <form id="addCategoryForm" onsubmit="createCategory(event)">
                <input type="text" id="newCategoryName" placeholder="Enter new category" class="border py-2 px-3 rounded w-full mb-4" required>
                <button type="submit" class="bg-blue-500 text-white py-2 px-4 rounded w-full">Add Category</button>
            </form>
        </div>

        <!-- Response Message -->
        <div id="responseMessage" class="hidden bg-green-100 text-green-700 p-4 rounded mb-4"></div>

        <!-- Category List -->
        <div id="categoryList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Category items will be populated here -->
        </div>
    </div>

    <script>
       

        function searchCategories() {
            const query = document.getElementById("searchBar").value;
            fetchCategories('asc', query);
        }
        function fetchCategories(order = 'asc', search = '') {
            fetch(`/categories/?order=${order}&search=${search}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderCategories(data.data);
                } else {
                    alert("Error fetching categories.");
                }
            })
            .catch(error => console.error('Error:', error));
        }


        // Display categories in the DOM
        function renderCategories(categories) {
            const categoryList = document.getElementById('categoryList');
            categoryList.innerHTML = ''; // Clear current list

            categories.forEach(category => {
                const categoryItem = document.createElement('div');
                categoryItem.classList.add('category-item', 'bg-white', 'p-6', 'rounded-lg', 'shadow-md', 'hover:shadow-lg', 'transition-shadow');
                categoryItem.setAttribute('data-id', category.id);
                categoryItem.innerHTML = `
                    <h3 class="category-name text-lg font-semibold mb-2">${category.nama_category}</h3>
                    <div class="mt-4 flex justify-between">
                        <button onclick="editCategory('${category.id}', '${category.nama_category}')" class="text-blue-500 hover:text-blue-700">Edit</button>
                        <button onclick="deleteCategory('${category.id}')" class="text-red-500 hover:text-red-700">Delete</button>
                    </div>
                `;
                categoryList.appendChild(categoryItem);
            });
        }

        // Fetch categories on page load
        document.addEventListener("DOMContentLoaded", function() {
            fetchCategories('asc');
        });


        // Create a new category via AJAX
        function createCategory(event) {
            event.preventDefault();
            const categoryName = document.getElementById("newCategoryName").value.trim();
            fetch('/categories/create/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ nama_category: categoryName })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage(data.message);
                    fetchCategories('asc'); // Refresh list
                    document.getElementById("newCategoryName").value = ""; // Clear input
                } else {
                    showMessage(data.message, true);
                }
            });
        }

        // Edit an existing category
        function editCategory(id, currentName) {
            const newName = prompt("Enter new name for the category:", currentName);
            if (newName && newName.trim() !== currentName) {
                fetch(`/categories/update/${id}/`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ nama_category: newName.trim() })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showMessage(data.message);
                        fetchCategories('asc');
                    } else {
                        showMessage(data.message, true);
                    }
                });
            }
        }

        // Delete a category
        function deleteCategory(id) {
            if (confirm("Are you sure you want to delete this category?")) {
                fetch(`/categories/delete/${id}/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showMessage(data.message);
                        fetchCategories('asc');
                    } else {
                        showMessage("Error deleting category.", true);
                    }
                });
            }
        }

        // Display response messages
        function showMessage(message, isError = false) {
            const responseMessage = document.getElementById("responseMessage");
            responseMessage.textContent = message;
            responseMessage.classList.remove("hidden");
            responseMessage.classList.toggle("bg-green-100", !isError);
            responseMessage.classList.toggle("bg-red-100", isError);
            responseMessage.classList.toggle("text-green-700", !isError);
            responseMessage.classList.toggle("text-red-700", isError);
        }

        // Fetch categories on page load
        document.addEventListener("DOMContentLoaded", function() {
            fetchCategories('asc');
        });
    </script>
</body>
</html>
